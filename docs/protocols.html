
<section id="protocol" class="informative">
    <h2>Protocol</h2>
    <p class="advisement">The following protocol specifications are unstable.</p>

    <section>
        <h3>CHAPI</h3>
        <p>
            See the <a href="https://w3c-ccg.github.io/credential-handler-api/">
             latest editors draft
             </a>.
         </p>
    </section>

    <section>
        <h3>WACI</h3>
        <p>
           See the <a href="https://github.com/decentralized-identity/waci-presentation-exchange">
            latest editors draft
            </a>.
        </p>
        <section>
            <h3>ProposePresentation</h3>
            <p>Accepts an out of band invitation and initiates share interaction from wallet by sending message proposing presentation.</p>
            <p>Takes <code>invitation</code> from relying party, optional <code>fromDID</code> to customize the DID to be used for sending message, optional <code>timeout</code>
             to wait for request presentation message from relying party and returns request presentation message from relying party.</p>
            <p>
                Refer <a href="https://identity.foundation/waci-presentation-exchange/#step-2-send-message-proposing-presentation">
                WACI Send Message Proposing Presentation</a> for more details.
            </p>
            <pre class="example highlight" title="Propose presentation from wallet example">
                // out of band invitation from relying party.
                let invitation = {
                      "type": "https://didcomm.org/out-of-band/2.0/invitation",
                      "id": "599f3638-b563-4937-9487-dfe55099d900",
                      "from": "did:example:verifier",
                      "body": {
                          "goal_code": "streamlined-vp",
                          "accept": ["didcomm/v2"]
                      }
                    }

                // accept invitation, send propose presentation message and wait for request presentation.
                let requestPresentation = await wallet.proposePresentation(invitation, "did:example:wallet", someTimeout)
            </pre>

            <pre class="example highlight" title="Sample of propose presentation message sent from wallet">
                {
                    "type": "https://didcomm.org/present-proof/3.0/propose-presentation",
                    "id": "95e63a5f-73e1-46ac-b269-48bb22591bfa",
                    "pthid": "599f3638-b563-4937-9487-dfe55099d900",
                    "from": "did:example:prover",
                    "to": "did:example:verifier"
                }
            </pre>

            <pre class="example highlight" title="Sample of request presentation message from relying party">
                {
                  "type": "https://didcomm.org/present-proof/3.0/request-presentation",
                  "id": "0ac534c8-98ed-4fe3-8a41-3600775e1e92",
                  "thid": "95e63a5f-73e1-46ac-b269-48bb22591bfa",
                  "from": "did:example:prover",
                  "to": "did:example:verifier",
                  "body": {},
                  "attachments": [
                    {
                      "@id": "ed7d9b1f-9eed-4bde-b81c-3aa7485cf947",
                      "mime-type": "application/json",
                      "format": "dif/presentation-exchange/definitions@v1.0",
                      "data": {
                        "json": {
                          "dif": {
                            "options": {
                              "challenge": "3fa85f64-5717-4562-b3fc-2c963f66afa7",
                              "domain": "4jt78h47fh47"
                            },
                            "presentation_definition": {
                              "id": "32f54163-7166-48f1-93d8-ff217bdb0654",
                              // The frame property is a JSON-LD frame which is an addition to
                              // presentation exchange that allows for selective disclosure
                              "frame": {
                                "@context": [
                                  "https://www.w3.org/2018/credentials/v1",
                                  "https://w3id.org/vaccination/v1",
                                  "https://w3id.org/security/suites/bls12381-2020/v1"
                                ],
                                "type": [
                                  "VerifiableCredential",
                                  "VaccinationCertificate"
                                ],
                                "credentialSubject": {
                                  "@explicit": true,
                                  "type": [
                                    "VaccinationEvent"
                                  ],
                                  "batchNumber": {},
                                  "countryOfVaccination": {}
                                }
                              },
                              "input_descriptors": [
                                {
                                  "id": "vaccination_input",
                                  "name": "Vaccination Certificate",
                                  "schema": "https://w3id.org/vaccination/#VaccinationCertificate",
                                  "constraints": {
                                    "fields": [
                                      {
                                        "path": [
                                          "$.credentialSubject.batchNumber"
                                        ],
                                        "filter": {
                                          "type": "string"
                                        }
                                      },
                                      {
                                        "path": [
                                          "$.credentialSubject.countryOfVaccination"
                                        ],
                                        "filter": {
                                          "type": "string"
                                        }
                                      }
                                    ]
                                  }
                                }
                              ]
                            }
                          }
                        }
                      }
                    }
                  ]
                }
            </pre>

        </section>

        <section>
            <h3>PresentProof</h3>
            <p>Takes <code>ThreadID</code> of the presentation request from ongoing credential interaction, <code>presentation</code> to be sent to relying party
                and optional <code>timeout</code> to wait for acknowledgement message from relying party.</p>
            <p>
                Refer <a href="https://identity.foundation/waci-presentation-exchange/#step-4-present-proof">
                    WACI Present Proof</a> for more details.
            </p>
            <pre class="example highlight" title="Present proof example">
                // presentation to be sent to relying party.
                let presentation = {
                                    "@context": [
                                      "https://www.w3.org/2018/credentials/v1",
                                      "https://identity.foundation/presentation-exchange/submission/v1"
                                    ],
                                    "type": [
                                      "VerifiablePresentation",
                                      "PresentationSubmission"
                                    ],
                                    "holder": "did:example:123",
                                    "verifiableCredential": [
                                      {
                                        "@context": [
                                          "https://www.w3.org/2018/credentials/v1",
                                          "https://w3id.org/vaccination/v1",
                                          "https://w3id.org/security/bbs/v1"
                                        ],
                                        "id": "urn:uvci:af5vshde843jf831j128fj",
                                        "type": [
                                          "VaccinationCertificate",
                                          "VerifiableCredential"
                                        ],
                                        "description": "COVID-19 Vaccination Certificate",
                                        "name": "COVID-19 Vaccination Certificate",
                                        "expirationDate": "2029-12-03T12:19:52Z",
                                        "issuanceDate": "2019-12-03T12:19:52Z",
                                        "issuer": "did:example:456",
                                        "credentialSubject": {
                                          "id": "urn:bnid:_:c14n2",
                                          "type": "VaccinationEvent",
                                          "batchNumber": "1183738569",
                                          "countryOfVaccination": "NZ"
                                        },
                                        "proof": {
                                          "type": "BbsBlsSignatureProof2020",
                                          "created": "2021-02-18T23:04:28Z",
                                          "nonce": "JNGovx4GGoi341v/YCTcZq7aLWtBtz8UhoxEeCxZFevEGzfh94WUSg8Ly/q+2jLqzzY=",
                                          "proofPurpose": "assertionMethod",
                                          "proofValue": "AB0GQA//jbDwMgaIIJeqP3fRyMYi6WDGhk0JlGJc/sk4ycuYGmyN7CbO4bA7yhIW/YQbHEkOgeMy0QM+usBgZad8x5FRePxfo4v1dSzAbJwWjx87G9F1lAIRgijlD4sYni1LhSo6svptDUmIrCAOwS2raV3G02mVejbwltMOo4+cyKcGlj9CzfjCgCuS1SqAxveDiMKGAAAAdJJF1pO6hBUGkebu/SMmiFafVdLvFgpMFUFEHTvElUQhwNSp6vxJp6Rs7pOVc9zHqAAAAAI7TJuDCf7ramzTo+syb7Njf6ExD11UKNcChaeblzegRBIkg3HoWgwR0hhd4z4D5/obSjGPKpGuD+1DoyTZhC/wqOjUZ03J1EtryZrC+y1DD14b4+khQVLgOBJ9+uvshrGDbu8+7anGezOa+qWT0FopAAAAEG6p07ghODpi8DVeDQyPwMY/iu2Lh7x3JShWniQrewY2GbsACBYOPlkNNm/qSExPRMe2X7UPpdsxpUDwqbObye4EXfAabgKd9gCmj2PNdvcOQAi5rIuJSGa4Vj7AtKoW/2vpmboPoOu4IEM1YviupomCKOzhjEuOof2/y5Adfb8JUVidWqf9Ye/HtxnzTu0HbaXL7jbwsMNn5wYfZuzpmVQgEXss2KePMSkHcfScAQNglnI90YgugHGuU+/DQcfMoA0+JviFcJy13yERAueVuzrDemzc+wJaEuNDn8UiTjAdVhLcgnHqUai+4F6ONbCfH2B3ohB3hSiGB6C7hDnEyXFOO9BijCTHrxPv3yKWNkks+3JfY28m+3NO0e2tlyH71yDX0+F6U388/bvWod/u5s3MpaCibTZEYoAc4sm4jW03HFYMmvYBuWOY6rGGOgIrXxQjx98D0macJJR7Hkh7KJhMkwvtyI4MaTPJsdJGfv8I+RFROxtRM7RcFpa4J5wF/wQnpyorqchwo6xAOKYFqCqKvI9B6Y7Da7/0iOiWsjs8a4zDiYynfYavnz6SdxCMpHLgplEQlnntqCb8C3qly2s5Ko3PGWu4M8Dlfcn4TT8YenkJDJicA91nlLaE8TJbBgsvgyT+zlTsRSXlFzQc+3KfWoODKZIZqTBaRZMft3S/",
                                          "verificationMethod": "did:example:123#key-1"
                                        }
                                      }
                                    ],
                                    "presentation_submission": {
                                      "id": "1d257c50-454f-4c96-a273-c5368e01fe63",
                                      "definition_id": "32f54163-7166-48f1-93d8-ff217bdb0654",
                                      "descriptor_map": [
                                        {
                                          "id": "vaccination_input",
                                          "format": "ldp_vp",
                                          "path": "$.verifiableCredential[0]"
                                        }
                                      ]
                                    },
                                    "proof": {
                                      "type": "Ed25519Signature2018",
                                      "verificationMethod": "did:example:123#key-0",
                                      "created": "2021-05-14T20:16:29.565377",
                                      "proofPurpose": "authentication",
                                      "challenge": "3fa85f64-5717-4562-b3fc-2c963f66afa7",
                                      "jws": "eyJhbGciOiAiRWREU0EiLCAiYjY0IjogZmFsc2UsICJjcml0IjogWyJiNjQiXX0..7M9LwdJR1_SQayHIWVHF5eSSRhbVsrjQHKUrfRhRRrlbuKlggm8mm_4EI_kTPeBpalQWiGiyCb_0OWFPtn2wAQ"
                                    }
                                  }

                // thread ID of the credential interaction.
                let threadID = "95e63a5f-73e1-46ac-b269-48bb22591bfa" // requestPresentation.thID

                // send present proof message and wait for acknowledgement message.
                let ack = await wallet.presentProof(threadID, presentation, someTimeout)
            </pre>

            <pre class="example highlight" title="Example of present proof message sent from wallet">
                {
                  "type": "https://didcomm.org/present-proof/3.0/presentation",
                  "id": "f1ca8245-ab2d-4d9c-8d7d-94bf310314ef",
                  "thid": "95e63a5f-73e1-46ac-b269-48bb22591bfa",
                  "from": "did:example:verifier",
                  "to": "did:example:prover",
                  "body": {},
                  "attachments": [
                    {
                      "@id": "2a3f1c4c-623c-44e6-b159-179048c51260",
                      "mime-type": "application/ld+json",
                      "format": "dif/presentation-exchange/submission@v1.0",
                      "data": {
                        "@context": [
                          "https://www.w3.org/2018/credentials/v1",
                          "https://identity.foundation/presentation-exchange/submission/v1"
                        ],
                        "type": [
                          "VerifiablePresentation",
                          "PresentationSubmission"
                        ],
                        "holder": "did:example:123",
                        "verifiableCredential": [
                          {
                            "@context": [
                              "https://www.w3.org/2018/credentials/v1",
                              "https://w3id.org/vaccination/v1",
                              "https://w3id.org/security/bbs/v1"
                            ],
                            "id": "urn:uvci:af5vshde843jf831j128fj",
                            "type": [
                              "VaccinationCertificate",
                              "VerifiableCredential"
                            ],
                            "description": "COVID-19 Vaccination Certificate",
                            "name": "COVID-19 Vaccination Certificate",
                            "expirationDate": "2029-12-03T12:19:52Z",
                            "issuanceDate": "2019-12-03T12:19:52Z",
                            "issuer": "did:example:456",
                            "credentialSubject": {
                              "id": "urn:bnid:_:c14n2",
                              "type": "VaccinationEvent",
                              "batchNumber": "1183738569",
                              "countryOfVaccination": "NZ"
                            },
                            "proof": {
                              "type": "BbsBlsSignatureProof2020",
                              "created": "2021-02-18T23:04:28Z",
                              "nonce": "JNGovx4GGoi341v/YCTcZq7aLWtBtz8UhoxEeCxZFevEGzfh94WUSg8Ly/q+2jLqzzY=",
                              "proofPurpose": "assertionMethod",
                              "proofValue": "AB0GQA//jbDwMgaIIJeqP3fRyMYi6WDGhk0JlGJc/sk4ycuYGmyN7CbO4bA7yhIW/YQbHEkOgeMy0QM+usBgZad8x5FRePxfo4v1dSzAbJwWjx87G9F1lAIRgijlD4sYni1LhSo6svptDUmIrCAOwS2raV3G02mVejbwltMOo4+cyKcGlj9CzfjCgCuS1SqAxveDiMKGAAAAdJJF1pO6hBUGkebu/SMmiFafVdLvFgpMFUFEHTvElUQhwNSp6vxJp6Rs7pOVc9zHqAAAAAI7TJuDCf7ramzTo+syb7Njf6ExD11UKNcChaeblzegRBIkg3HoWgwR0hhd4z4D5/obSjGPKpGuD+1DoyTZhC/wqOjUZ03J1EtryZrC+y1DD14b4+khQVLgOBJ9+uvshrGDbu8+7anGezOa+qWT0FopAAAAEG6p07ghODpi8DVeDQyPwMY/iu2Lh7x3JShWniQrewY2GbsACBYOPlkNNm/qSExPRMe2X7UPpdsxpUDwqbObye4EXfAabgKd9gCmj2PNdvcOQAi5rIuJSGa4Vj7AtKoW/2vpmboPoOu4IEM1YviupomCKOzhjEuOof2/y5Adfb8JUVidWqf9Ye/HtxnzTu0HbaXL7jbwsMNn5wYfZuzpmVQgEXss2KePMSkHcfScAQNglnI90YgugHGuU+/DQcfMoA0+JviFcJy13yERAueVuzrDemzc+wJaEuNDn8UiTjAdVhLcgnHqUai+4F6ONbCfH2B3ohB3hSiGB6C7hDnEyXFOO9BijCTHrxPv3yKWNkks+3JfY28m+3NO0e2tlyH71yDX0+F6U388/bvWod/u5s3MpaCibTZEYoAc4sm4jW03HFYMmvYBuWOY6rGGOgIrXxQjx98D0macJJR7Hkh7KJhMkwvtyI4MaTPJsdJGfv8I+RFROxtRM7RcFpa4J5wF/wQnpyorqchwo6xAOKYFqCqKvI9B6Y7Da7/0iOiWsjs8a4zDiYynfYavnz6SdxCMpHLgplEQlnntqCb8C3qly2s5Ko3PGWu4M8Dlfcn4TT8YenkJDJicA91nlLaE8TJbBgsvgyT+zlTsRSXlFzQc+3KfWoODKZIZqTBaRZMft3S/",
                              "verificationMethod": "did:example:123#key-1"
                            }
                          }
                        ],
                        "presentation_submission": {
                          "id": "1d257c50-454f-4c96-a273-c5368e01fe63",
                          "definition_id": "32f54163-7166-48f1-93d8-ff217bdb0654",
                          "descriptor_map": [
                            {
                              "id": "vaccination_input",
                              "format": "ldp_vp",
                              "path": "$.verifiableCredential[0]"
                            }
                          ]
                        },
                        "proof": {
                          "type": "Ed25519Signature2018",
                          "verificationMethod": "did:example:123#key-0",
                          "created": "2021-05-14T20:16:29.565377",
                          "proofPurpose": "authentication",
                          "challenge": "3fa85f64-5717-4562-b3fc-2c963f66afa7",
                          "jws": "eyJhbGciOiAiRWREU0EiLCAiYjY0IjogZmFsc2UsICJjcml0IjogWyJiNjQiXX0..7M9LwdJR1_SQayHIWVHF5eSSRhbVsrjQHKUrfRhRRrlbuKlggm8mm_4EI_kTPeBpalQWiGiyCb_0OWFPtn2wAQ"
                        }
                      }
                    }
                  ]
                }
            </pre>

            <pre class="example highlight" title="Example of acknowledgement message from relying party">
                {
                  "type":"https://didcomm.org/present-proof/3.0/ack",
                  "id":"e2f3747b-41e8-4e46-abab-ba51472ab1c3",
                  "pthid":"95e63a5f-73e1-46ac-b269-48bb22591bfa",
                  "from":"did:example:verifier",
                  "to":"did:example:prover",
                  "body":{
                    "status":"OK",
                    "redirectUrl":"https://example.com/redirect-url?id={{Some id that identifies the user}}"
                  }
                }
            </pre>

        </section>

    </section>

    <section>
        <h3>SIOP</h3>
        <p class="issue">
           This protocol is not currently stable.
        </p>
    </section>

</section>
